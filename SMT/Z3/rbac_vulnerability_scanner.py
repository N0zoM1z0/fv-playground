#!/usr/bin/env python3
"""
Z3 RBAC æƒé™è¶Šæƒæ¼æ´æ‰«æå™¨ - å®‰å…¨å®æˆ˜
ä½¿ç”¨ SMT æ±‚è§£å™¨è‡ªåŠ¨å‘ç°æƒé™ç»•è¿‡æ¼æ´
"""

from z3 import Solver, Int, String, And, Or, Not, sat, unsat, If


def define_rbac_model():
    """
    å®šä¹‰ RBAC æƒé™æ¨¡å‹
    æ¨¡æ‹Ÿä¸€ä¸ªå…¸å‹ä¼ä¸šç³»ç»Ÿçš„æƒé™æ ¡éªŒè§„åˆ™
    """
    # è§’è‰²æšä¸¾å€¼
    ROLES = {
        "guest": 0,      # è®¿å®¢ - åªèƒ½æŸ¥çœ‹å…¬å¼€èµ„æº
        "user": 1,       # æ™®é€šç”¨æˆ· - æ“ä½œå—é™èµ„æº
        "vip": 2,        # VIP ç”¨æˆ· - æ›´å¤šæƒé™
        "moderator": 3,  # ç‰ˆä¸» - ç®¡ç†å†…å®¹
        "admin": 4,      # ç®¡ç†å‘˜ - å‡ ä¹å…¨æƒé™
        "superadmin": 5  # è¶…çº§ç®¡ç†å‘˜ - æ‰€æœ‰æƒé™
    }

    # èµ„æºæ•æ„Ÿåº¦ç­‰çº§
    # 0=å…¬å¼€, 1=å†…éƒ¨, 2=æœºå¯†, 3=é«˜åº¦æœºå¯†, 4=æ ¸å¿ƒæ•°æ®, 5=ç³»ç»Ÿå…³é”®

    # æ“ä½œç±»å‹æšä¸¾å€¼
    ACTIONS = {
        "read": 0,
        "create": 1,
        "update": 2,
        "delete": 3,
        "export": 4,
        "delete_db": 99,  # é«˜å±æ“ä½œï¼šåˆ é™¤æ•°æ®åº“
        "grant_admin": 100  # é«˜å±æ“ä½œï¼šæˆäºˆç®¡ç†å‘˜æƒé™
    }

    return ROLES, ACTIONS


def create_access_control_rules(solver, user_role, resource_level, action):
    """
    å®šä¹‰ç³»ç»Ÿçš„æƒé™æ ¡éªŒè§„åˆ™
    è¿™äº›è§„åˆ™æ¨¡æ‹ŸçœŸå®çš„ä¼ä¸šç³»ç»Ÿæƒé™æ§åˆ¶
    """
    ROLES, ACTIONS = define_rbac_model()

    # ========== è§„åˆ™å®šä¹‰ ==========
    rules = []

    # è§„åˆ™ 1: è®¿å®¢åªèƒ½è¯»å–å…¬å¼€èµ„æº
    # If role == "guest" -> resource_level must be 0 AND action must be "read"
    rule_guest = Or(
        user_role != ROLES["guest"],
        And(resource_level == 0, action == ACTIONS["read"])
    )
    rules.append(("Gueståªèƒ½è¯»å…¬å¼€èµ„æº", rule_guest))

    # è§„åˆ™ 2: æ™®é€šç”¨æˆ·åªèƒ½è®¿é—® resource_level < 3 çš„èµ„æº
    # If role == "user" -> resource_level < 3
    rule_user_resource = Or(
        user_role != ROLES["user"],
        resource_level < 3
    )
    rules.append(("Userèµ„æºç­‰çº§<3", rule_user_resource))

    # è§„åˆ™ 3: æ™®é€šç”¨æˆ·ä¸èƒ½æ‰§è¡Œ delete æ“ä½œ
    # If role == "user" -> action != delete
    rule_user_delete = Or(
        user_role != ROLES["user"],
        action != ACTIONS["delete"]
    )
    rules.append(("Userä¸èƒ½åˆ é™¤", rule_user_delete))

    # è§„åˆ™ 4: VIP ç”¨æˆ·å¯ä»¥è®¿é—® resource_level < 4 çš„èµ„æº
    # If role == "vip" -> resource_level < 4
    # âš ï¸ BUG: è¾¹ç•Œæ¡ä»¶é”™è¯¯ï¼åº”è¯¥æ˜¯ < 4ï¼Œä½†å†™æˆäº† <= 4
    # è¿™å¯¼è‡´ VIP å¯ä»¥è®¿é—® resource_level == 4 çš„èµ„æºï¼ˆåº”è¯¥æ˜¯ admin ä¸“å±ï¼‰
    rule_vip_resource = Or(
        user_role != ROLES["vip"],
        resource_level <= 4  # BUG: åº”è¯¥æ˜¯ < 4
    )
    rules.append(("VIPèµ„æºç­‰çº§<=4", rule_vip_resource))

    # è§„åˆ™ 5: åªæœ‰ moderator åŠä»¥ä¸Šå¯ä»¥æ‰§è¡Œ delete
    # If action == delete -> role >= moderator
    rule_delete_role = Or(
        action != ACTIONS["delete"],
        user_role >= ROLES["moderator"]
    )
    rules.append(("Deleteéœ€è¦moderator+", rule_delete_role))

    # è§„åˆ™ 6: åªæœ‰ admin åŠä»¥ä¸Šå¯ä»¥è®¿é—® resource_level >= 4 çš„èµ„æº
    # If resource_level >= 4 -> role >= admin
    rule_high_resource = Or(
        resource_level < 4,
        user_role >= ROLES["admin"]
    )
    rules.append(("é«˜ç­‰çº§èµ„æºéœ€è¦admin+", rule_high_resource))

    # è§„åˆ™ 7: åªæœ‰ admin å¯ä»¥æ‰§è¡Œ export æ“ä½œ
    # If action == export -> role >= admin
    rule_export = Or(
        action != ACTIONS["export"],
        user_role >= ROLES["admin"]
    )
    rules.append(("Exportéœ€è¦admin+", rule_export))

    # è§„åˆ™ 8: åªæœ‰ superadmin å¯ä»¥æ‰§è¡Œ delete_db
    # If action == delete_db -> role == superadmin
    # âš ï¸ BUG: è¿™é‡Œæœ‰ä¸€ä¸ªæ¼æ´ï¼å¿˜è®°æ·»åŠ çº¦æŸäº†ï¼
    # æ­£ç¡®çš„åº”è¯¥æ˜¯ï¼š
    # rule_delete_db = Or(
    #     action != ACTIONS["delete_db"],
    #     user_role == ROLES["superadmin"]
    # )
    # ç”±äºå¼€å‘ç–å¿½ï¼Œè¿™æ¡è§„åˆ™è¢«æ³¨é‡Šæ‰äº†ï¼Œå¯¼è‡´ä»»ä½•è§’è‰²éƒ½å¯ä»¥æ‰§è¡Œ delete_dbï¼

    # è§„åˆ™ 9: åªæœ‰ superadmin å¯ä»¥æ‰§è¡Œ grant_admin
    # If action == grant_admin -> role == superadmin
    # âš ï¸ BUG: è¿™é‡Œæœ‰å¦ä¸€ä¸ªæ¼æ´ï¼æ¡ä»¶å†™é”™äº†ï¼
    # å¼€å‘è€…è¯¯æŠŠ == å†™æˆäº† !=ï¼Œå¯¼è‡´åªæœ‰é superadmin èƒ½æ‰§è¡Œ grant_adminï¼
    rule_grant_admin = Or(
        action != ACTIONS["grant_admin"],
        user_role != ROLES["superadmin"]  # BUG: åº”è¯¥æ˜¯ ==
    )
    rules.append(("GrantAdminéœ€è¦superadmin", rule_grant_admin))

    # è§„åˆ™ 10: èµ„æºç­‰çº§å¿…é¡»åœ¨æœ‰æ•ˆèŒƒå›´å†…
    rule_resource_range = And(resource_level >= 0, resource_level <= 5)
    rules.append(("èµ„æºç­‰çº§èŒƒå›´0-5", rule_resource_range))

    # è§„åˆ™ 11: è§’è‰²å¿…é¡»åœ¨æœ‰æ•ˆèŒƒå›´å†…
    rule_role_range = And(user_role >= 0, user_role <= 5)
    rules.append(("è§’è‰²èŒƒå›´0-5", rule_role_range))

    # æ·»åŠ æ‰€æœ‰è§„åˆ™åˆ° solver
    for name, rule in rules:
        solver.add(rule)

    return rules


def check_vulnerability(solver, user_role, resource_level, action,
                        vuln_name, vuln_constraint, ROLES, ACTIONS):
    """
    æ£€æŸ¥ç‰¹å®šè¶Šæƒæ¼æ´æ˜¯å¦å­˜åœ¨

    vuln_constraint: æè¿°è¶Šæƒåœºæ™¯çš„çº¦æŸæ¡ä»¶
    """
    print(f"\n{'='*60}")
    print(f"[æ¼æ´æ£€æµ‹] {vuln_name}")
    print(f"{'='*60}")
    print(f"æ£€æµ‹æ¡ä»¶: {vuln_constraint}")

    # åˆ›å»ºæ–°çš„ solverï¼Œå¤åˆ¶åŸçº¦æŸ
    check_solver = Solver()
    for assert_ in solver.assertions():
        check_solver.add(assert_)

    # æ·»åŠ è¶Šæƒåœºæ™¯çº¦æŸ
    check_solver.add(vuln_constraint)

    # æ£€æŸ¥æ˜¯å¦å¯æ»¡è¶³
    result = check_solver.check()

    if result == sat:
        print(f"\n  âš ï¸  æ¼æ´å­˜åœ¨! (sat)")
        model = check_solver.model()

        role_val = model.evaluate(user_role).as_long()
        res_val = model.evaluate(resource_level).as_long()
        act_val = model.evaluate(action).as_long()

        # åå‘æŸ¥æ‰¾åç§°
        role_name = [k for k, v in ROLES.items() if v == role_val][0]
        act_name = [k for k, v in ACTIONS.items() if v == act_val][0]

        print(f"  æ”»å‡»å‘é‡:")
        print(f"    - è§’è‰²: {role_name} (value={role_val})")
        print(f"    - èµ„æºç­‰çº§: {res_val}")
        print(f"    - æ“ä½œ: {act_name} (value={act_val})")
        return True, (role_name, res_val, act_name)
    else:
        print(f"\n  âœ… å®‰å…¨ (unsat) - ä¸å­˜åœ¨æ­¤ç±»è¶Šæƒåœºæ™¯")
        return False, None


def main():
    print("="*70)
    print("     Z3 SMT å®‰å…¨æ‰«æå™¨ - RBAC æƒé™è¶Šæƒæ¼æ´æ£€æµ‹")
    print("="*70)

    ROLES, ACTIONS = define_rbac_model()

    # æ‰“å°æƒé™æ¨¡å‹
    print("\n[ç³»ç»Ÿæƒé™æ¨¡å‹]")
    print("-"*70)
    print("è§’è‰²ç­‰çº§:")
    for name, val in sorted(ROLES.items(), key=lambda x: x[1]):
        print(f"  {val}: {name}")

    print("\nèµ„æºæ•æ„Ÿåº¦ç­‰çº§:")
    print("  0: å…¬å¼€ (Public)")
    print("  1: å†…éƒ¨ (Internal)")
    print("  2: æœºå¯† (Confidential)")
    print("  3: é«˜åº¦æœºå¯† (Highly Confidential)")
    print("  4: æ ¸å¿ƒæ•°æ® (Core Data)")
    print("  5: ç³»ç»Ÿå…³é”® (System Critical)")

    print("\næ“ä½œç±»å‹:")
    for name, val in sorted(ACTIONS.items(), key=lambda x: x[1]):
        print(f"  {val}: {name}")

    # åˆå§‹åŒ– Z3 å˜é‡
    user_role = Int('user_role')
    resource_level = Int('resource_level')
    action = Int('action')

    # åˆ›å»º solver å¹¶æ·»åŠ æƒé™è§„åˆ™
    solver = Solver()
    rules = create_access_control_rules(solver, user_role, resource_level, action)

    print("\n[å·²åŠ è½½çš„æƒé™è§„åˆ™]")
    print("-"*70)
    for i, (name, _) in enumerate(rules, 1):
        print(f"  {i}. {name}")

    # ========== æ¼æ´æ£€æµ‹ ==========
    print("\n" + "="*70)
    print("                    å¼€å§‹è¶Šæƒæ¼æ´æ£€æµ‹")
    print("="*70)

    vulnerabilities = [
        # 1. éç®¡ç†å‘˜åˆ é™¤æ•°æ®åº“
        ("éSuperAdminæ‰§è¡ŒDeleteDB",
         And(user_role != ROLES["superadmin"],
             action == ACTIONS["delete_db"])),

        # 2. æ™®é€šç”¨æˆ·è®¿é—®é«˜ç­‰çº§èµ„æº
        ("Userè®¿é—®resource_level>=4çš„èµ„æº",
         And(user_role == ROLES["user"],
             resource_level >= 4)),

        # 3. éç®¡ç†å‘˜æ‰§è¡Œå¯¼å‡º
        ("éAdminæ‰§è¡ŒExportæ“ä½œ",
         And(user_role < ROLES["admin"],
             action == ACTIONS["export"])),

        # 4. è®¿å®¢æ‰§è¡Œå†™æ“ä½œ
        ("Guestæ‰§è¡ŒéReadæ“ä½œ",
         And(user_role == ROLES["guest"],
             action != ACTIONS["read"])),

        # 5. æ™®é€šç”¨æˆ·æ‰§è¡Œåˆ é™¤
        ("Useræ‰§è¡ŒDeleteæ“ä½œ",
         And(user_role == ROLES["user"],
             action == ACTIONS["delete"])),

        # 6. VIPè®¿é—®ç³»ç»Ÿå…³é”®èµ„æº
        ("VIPè®¿é—®resource_level=5çš„èµ„æº",
         And(user_role == ROLES["vip"],
             resource_level == 5)),

        # 7. éSuperAdminæˆäºˆç®¡ç†å‘˜æƒé™
        ("éSuperAdminæ‰§è¡ŒGrantAdmin",
         And(user_role != ROLES["superadmin"],
             action == ACTIONS["grant_admin"])),

        # 8. Moderatoråˆ é™¤æ•°æ®åº“
        ("Moderatoræ‰§è¡ŒDeleteDB",
         And(user_role == ROLES["moderator"],
             action == ACTIONS["delete_db"])),
    ]

    found_vulns = []
    for vuln_name, vuln_constraint in vulnerabilities:
        exists, details = check_vulnerability(
            solver, user_role, resource_level, action,
            vuln_name, vuln_constraint, ROLES, ACTIONS
        )
        if exists:
            found_vulns.append((vuln_name, details))

    # ========== æ€»ç»“ ==========
    print("\n" + "="*70)
    print("                         æ‰«ææ€»ç»“")
    print("="*70)

    if found_vulns:
        print(f"\n  ğŸ”´ å‘ç° {len(found_vulns)} ä¸ªè¶Šæƒæ¼æ´!")
        print("\n  æ¼æ´åˆ—è¡¨:")
        for i, (name, details) in enumerate(found_vulns, 1):
            role, res, act = details
            print(f"    {i}. {name}")
            print(f"       åˆ©ç”¨: {role} + èµ„æºç­‰çº§{res} + {act}")
    else:
        print("\n  ğŸŸ¢ æœªå‘ç°è¶Šæƒæ¼æ´ï¼Œæƒé™æ§åˆ¶è‰¯å¥½!")

    # é¢å¤–ï¼šç”Ÿæˆä¸€ä¸ªåˆæ³•çš„è®¿é—®ç¤ºä¾‹
    print("\n" + "="*70)
    print("                    åˆæ³•è®¿é—®ç¤ºä¾‹ç”Ÿæˆ")
    print("="*70)

    legit_solver = Solver()
    for assert_ in solver.assertions():
        legit_solver.add(assert_)

    # æ·»åŠ ä¸€äº›åˆæ³•åœºæ™¯çº¦æŸ
    legit_solver.add(user_role == ROLES["admin"])
    legit_solver.add(action == ACTIONS["export"])
    legit_solver.add(resource_level == 4)

    if legit_solver.check() == sat:
        model = legit_solver.model()
        role_val = model.evaluate(user_role).as_long()
        res_val = model.evaluate(resource_level).as_long()
        act_val = model.evaluate(action).as_long()

        role_name = [k for k, v in ROLES.items() if v == role_val][0]
        act_name = [k for k, v in ACTIONS.items() if v == act_val][0]

        print(f"\n  åˆæ³•è®¿é—®ç¤ºä¾‹:")
        print(f"    - è§’è‰²: {role_name}")
        print(f"    - èµ„æºç­‰çº§: {res_val}")
        print(f"    - æ“ä½œ: {act_name}")
        print(f"    ç»“æœ: âœ… å…è®¸è®¿é—®")

    print("\n" + "="*70)
    print("æ‰«æå®Œæˆ!")
    print("="*70)


if __name__ == "__main__":
    main()
